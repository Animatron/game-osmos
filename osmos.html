<!DOCTYPE html>
<html>
	<head>
		<title>Bejeweled - Animatron HTML5 Player Demo</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script src="../player/vendor/matrix.js" type="text/javascript"></script>
		<script src="../player/anm.player.js" type="text/javascript"></script>
		<script src="../player/anm.builder.js" type="text/javascript"></script>
		<script src="../player/animatron_import.js" type="text/javascript"></script>

		<script type="text/javascript">
			var b = Builder._$, B = Builder, C = anm.C;
			
			// canvas1
            var scene1 = b();
			
			function toHex(n) {
				return ((n < 16) ? '0' : '') + n.toString(16);
			}
			
			function hsvToHex(h, s, v) {
				var r, g, b;

   				var i = Math.floor(h * 6);
    			var f = h * 6 - i;
    			var p = v * (1 - s);
    			var q = v * (1 - f * s);
    			var t = v * (1 - (1 - f) * s);

    			switch(i % 6){
        			case 0: r = v, g = t, b = p; break;
        			case 1: r = q, g = v, b = p; break;
        			case 2: r = p, g = v, b = t; break;
        			case 3: r = p, g = q, b = v; break;
        			case 4: r = t, g = p, b = v; break;
        			case 5: r = v, g = p, b = q; break;
    			}
				
				return '#' + toHex(Math.floor(r*255)) + toHex(Math.floor(g*255)) + toHex(Math.floor(b*255));
			}
			
			function make(h) {
				return b().paint(function(ctx) {
					ctx.beginPath();
					ctx.arc(0, 0, 1, 0, 2*Math.PI, false);
					ctx.fillStyle = hsvToHex(h, 1, .7);
        			ctx.fill();
					ctx.closePath();
					ctx.beginPath();
					ctx.arc(-.1, -.1, .75, 0, 2*Math.PI, false);
					ctx.fillStyle = hsvToHex(h, 1, .8);
        			ctx.fill();
					ctx.closePath();
					ctx.beginPath();
					ctx.arc(-.2, -.2, .5, 0, 2*Math.PI, false);
					ctx.fillStyle = hsvToHex(h, 1, .9);
        			ctx.fill();
					ctx.closePath();
					ctx.beginPath();
					ctx.arc(-.3, -.3, .25, 0, 2*Math.PI, false);
					ctx.fillStyle = hsvToHex(h, 1, 1);
        			ctx.fill();
					ctx.closePath();
				});
			}
			
			
            function start() {
				var testModifier = function(t) {
					this.x = 20;
					this.y = 20;
					this.sx = b(this.$).data().r;
					this.sy = b(this.$).data().r;
					this.alpha = Math.cos(t)/2 + .5;
				}
				
				var dot = make(119/360).data({'r': 20, 'vx': 0, 'vy': 0}).modify(testModifier);
				scene1.add(dot);
				
				scene1.on(C.X_MCLICK, function(evt) {
					// find masses
					var e = .1;
					var m = 4*Math.pow(dot.data().r, 3)/3;
					var m1 = (1-e) * m;
					var m2 = e*m;
					var r1 = Math.pow(3*m1/4, 1/3);
					var r2 = Math.pow(3*m2/4, 1/3);
					var vx = dot.data().vx;
					var vy = dot.data().vy;
					
					// find new velocities
					// m1*vx1 + m2*vx2 = m*vx
					// m1*vx1^2/2 + m2*vx2^2/2 = m*vx^2/2	
					
					// m1^2*vx1^2 = m2^2*vx2^2
					// m1*vx1^2 = -m2*vx2^2
					
					// (m1^2 + m1)*vx1^2 = (m2^2 - m2)*vx2^2
					// (m2^2 + m2)*vx2^2 = (m1^2 - m1)*vx1^2
					
					// m1*vx1^2/2 + m2*(m1^2 + m1)*vx1^2/(2*(m2^2 - m2)) = m*vx^2/2
					// vx1^2*(m1 + m2*(m1^2 + m1)/(m2^2 - m2)) = m*vx^2
					
					var vx1 = Math.sqrt(m*vx*vx/(m1 + m2*(m1*m1 + m1)/(m2*m2 - m2)));
					var vx2 = -m1*vx1/m2;
					vx1 += vx;
					vx2 += vx;
					var vy1 = Math.sqrt(m*vy*vy/(m1 + m2*(m1*m1 + m1)/(m2*m2 - m2)));
					var vy2 = -m1*vy1/m2;
					vy1 += vy;
					vy2 += vy;
					
					// TODO: form new objects with resultant mass and velocity
					
				});
				
                createPlayer('canvas1', {'mode': C.M_DYNAMIC}).load(scene1).play();
    
            }
        </script>
      </head>

	<body onload="start();">
		<h1>Osmos - Animatron HTML5 Player Demo</h1>

		<!-- canvas1 -->
		<canvas id="canvas1"></canvas>

	</body>

</html>